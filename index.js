const cron = require('node-cron')
const nodemailer = require('nodemailer')
const fs = require('fs')
const moment = require('moment')

clientEmailMap = {
    'Hack the Box': {
        name: 'Salvatore Hodkiewicz (Hackthebox)',
        vEmail: 'htb_salvatore.hodkiewicz@clients.stuniq.me',
        email: 'abhirambsn@gmail.com',
        password: 'JCsd6SO72j09nbc8'
    },
    'Vulnhub': {
        name: 'Eunice Kessler (Vulnhub)',
        vEmail: 'vhub_eunice.kessler@clients.stuniq.me',
        email: 'abhirambsn@gmail.com',
        password: 'JCsd6SO72j09nbc8'
    }
}

const getMailOptions = (email, APPNAME, clientName, spocName, url, deadline) => {
    let mailoptions = {
        from: `${spocName} <${email}>`,
        to: "abhiram.bsn@outlook.com",
        subject: `Penetration Test Requested - ${APPNAME}`,
        html: `
        <b>Respected Sir,</b>
        <p>We have been given the following data for a penetration test, part of mandatory testing compliance before go live.</p>
        <p>
        Details are as follows:<br/><br/>
        <b>Client Name:</b> ${clientName}<br />
        <b>Application Name:</b> ${APPNAME}<br/>
        <b>URL:</b> <a href='${url}'>${url}</a> <i>(if its a generic url, then login and search for the app)</i><br/>
        </p>
        <p>Furhter, we request you to complete the testing and provide us the report by <b>${moment(deadline).format("dddd, DD MMM YYYY")}</b>, in case of any delays a prior headsup would be appreciated</p>
        <p>
        Thanks and Regards,<br/>
        <b>${spocName} </b><br/>
        <b>Deployment and QA Team</b> <br/>
        <b>${clientName}</b> <br/>
        </p>
        `
    }
    return mailoptions
}

const getMailTransporter = (email, password) => {
    const transporter = nodemailer.createTransport({
        host: 'smtp-relay.brevo.com',
        port: 587,
        auth: {
            user: email,
            pass: password
        }
    })
    return transporter
}

const getApp = () => {
    const dataFile = fs.readFileSync('./data.json')
    const jsonData = JSON.parse(dataFile)
    const randIndex = Math.floor(Math.random() * jsonData.length)
    const app = jsonData[randIndex]
    return {
        ...app,
        deadline: moment().add(14, 'd').toDate()
    }
}

const getClientDetails = (app) => {
    return clientEmailMap[app['Client Name']]
}

const sendClientEmail = async () => {
    const appData = getApp();
    const {vEmail, email, name, password} = getClientDetails(appData);
    const transporter = getMailTransporter(email, password);
    const options = getMailOptions(vEmail, appData['Machine Name'], appData['Client Name'], name, appData.URL, appData.deadline)
    transporter.sendMail(options, (err, info) => {
        if (err) console.error(err)
        else console.log('New Pentest Requested, Data sent to email: ' + info.response)
    });
}

// console.log(sendClientEmail())

cron.schedule('12 0 * * *', async () => {
    console.log('Sending Pentest Mails')
    await sendClientEmail();
    console.log('Pentest Request Mails Sent')
});

console.log("Cron Jobs Scheduled")

